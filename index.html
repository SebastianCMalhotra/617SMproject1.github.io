<!DOCTYPE html>
<meta charset="utf-8">
<html>
    <head>
        <title>Dear Data Redux Visualization 2</title>
        <script src="https://d3js.org/d3.v6.js"></script>
        <style>
            body {
                background-color: #fdfaf0;
                font-family: 'Courier New', Courier, monospace;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding-top: 20px;
            }
            #chart {
                background: white;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                border-radius: 8px;
                padding: 20px;
            }
        </style>
    </head>
    <body>
        <div id="tooltip" style="position: absolute; opacity: 0; background: #3e2723; color: white; padding: 8px; border-radius: 4px; pointer-events: none; font-size: 12px; z-index: 10;"></div>
        <div id="chart"></div>

        <script>
            const parseDate = d3.timeParse("%m/%d/%Y"); 
            const cellSize = 45; 

            const margin = {top: 80, right: 40, bottom: 60, left: 70},
                  width = 960 - margin.left - margin.right,
                  height = 500 - margin.top - margin.bottom;

            const svg = d3.select("#chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);

            d3.csv("DearDataRedux - Question2.csv", function(d){
                const dateWithYear = d["Date"] + "/2026";
                return {
                    Date: parseDate(dateWithYear), 
                    Cups: +d["Cups"] 
                };
            }).then(function(data) {
                data = data.filter(d => d.Date !== null);
                
                if (data.length === 0) {
                    console.error("Data loaded but dates are not parsing! Check your parseDate format.");
                    return;
                }

                const colorScale = d3.scaleSequential()
                    .domain([0, d3.max(data, d => d.Cups)])
                    .interpolator(d3.interpolateRgb("#f5f5f5", "#3e2723"));

                svg.selectAll(".day-rect")
                    .data(data)
                    .join("rect")
                    .attr("width", cellSize - 3)
                    .attr("height", cellSize - 3)
                    .attr("x", d => d3.timeWeek.count(d3.timeYear(d.Date), d.Date) * cellSize)
                    .attr("y", d => d.Date.getDay() * cellSize)
                    .style("fill", d => colorScale(d.Cups))
                    .style("stroke", "#eee");

                const tooltip = d3.select("#tooltip");

                svg.selectAll(".mug-image")
                    .data(data)
                    .join("image")
                    .attr("class", "mug-image")
                    .attr("xlink:href", "mug.png")
                    .attr("width", d => 15 + (d.Cups * 4)) 
                    .attr("height", d => 15 + (d.Cups * 4))
                    .attr("x", d => {
                        const xPos = d3.timeWeek.count(d3.timeYear(d.Date), d.Date) * cellSize;
                        const size = 15 + (d.Cups * 4);
                        return xPos + (cellSize / 2) - (size / 2);
                    })
                    .attr("y", d => {
                        const yPos = d.Date.getDay() * cellSize;
                        const size = 15 + (d.Cups * 4);
                        return yPos + (cellSize / 2) - (size / 2);
                    })
                    .style("filter", d => `drop-shadow(0 0 0 ${colorScale(d.Cups)}) sepia(1)`)
                    .style("opacity", d => d.Cups > 0 ? 1 : 0.1)
                    .style("cursor", "pointer")
                    .on("mouseover", function(event, d) {
                        d3.select(this).transition().duration(100).attr("transform", "scale(1.2)");
                        
                        tooltip.transition().duration(200).style("opacity", .9);
                        tooltip.html(`${d3.timeFormat("%B %d")(d.Date)}<br/>${d.Cups} Cups`)
                               .style("left", (event.pageX + 10) + "px")
                               .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function() {
                        d3.select(this).transition().duration(100).attr("transform", "scale(1)");
                        tooltip.transition().duration(500).style("opacity", 0);
                    });

                const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
                svg.selectAll(".day-label")
                    .data(days)
                    .join("text")
                    .attr("x", -10)
                    .attr("y", (d, i) => i * cellSize + 25)
                    .style("text-anchor", "end")
                    .style("font-size", "12px")
                    .text(d => d);

                const monthLabels = data.filter(d => d.Date.getDate() === 1 || d === data[0]);
                svg.selectAll(".month-label")
                    .data(monthLabels)
                    .join("text")
                    .attr("x", d => d3.timeWeek.count(d3.timeYear(d.Date), d.Date) * cellSize)
                    .attr("y", -15)
                    .style("font-size", "14px")
                    .style("font-weight", "bold")
                    .text(d => d3.timeFormat("%b")(d.Date));

                svg.append("text")
                    .attr("x", 0)
                    .attr("y", -50)
                    .style("font-size", "22px")
                    .style("text-decoration", "underline")
                    .text("Caffeine Consumption Heatmap");

            }).catch(err => {
                console.error("CSV loading failed. Check the filename!", err);
            });
        </script>
    </body>
</html>


